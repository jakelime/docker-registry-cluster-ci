# Docker builder for Nginx

Builds nginx docker instance.

This is designed to be a git submodule to be used as part of the docker-compose method.

The nginx service is meant to be a in the web layer, serving as a Load Balancer and
provide reverse-proxy service to the backend application layers and/or database layer.

This deployments uses self-signed HTTPS certificate. The builder script will generate
a self-signed certificate for deployment.

## Folder Structure

```text
.[docker-compose root dir]
├── src-nginx/
│   ├── certs/ # (this will be created by build script)
|   |   ├── nginx.crt
│   │   └── nginx.key
│   ├── templates/
│   │   └── default.conf.template # (refer to official docs, envsubst using nginx-docker-image's templates)
│   └── Dockerfile
│
├── src-django-app1/
│   └── app1/
|       ├── main/
|       ├── .env
|       ├── Dockerfile
│       └── requirements.txt
│
└── readme.md
```

## Example docker-compose.yml

```yaml
services:
  nginx:
    restart: unless-stopped
    container_name: ${PROJECT_NAME}_nginx
    build:
      context: ./src-nginx
      args:
        url_docker: ${url_docker_index}
    environment:
      - NGINX_PORT_HTTP=80
      - NGINX_PORT_HTTPS=443
      - APP0_PORT=8000
      - APP1_PORT=8001
      - APP2_PORT=8002
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./src-nginx/templates:/etc/nginx/templates
      - datalogs:/datalogs
      - datacache_nginx:/var/cache/nginx
      - ./src-nginx/www:/var/www/html:ro
      - datashare:/datashare
    networks:
      - app_net

  app0:
    restart: unless-stopped
    container_name: ${PROJECT_NAME}_app0
    env_file:
      - ./src-app0/.env.docker
    build:
      context: ./src-app0
      args:
        url_pypi: ${url_pypi_index}
        url_docker: ${url_docker_index}
    environment:
      - DJANGO_SUPERUSER_USERNAME=admin
      - DJANGO_SUPERUSER_PASSWORD=myVerySecretPswd
      - DJANGO_SUPERUSER_EMAIL=admin@rockingclimbing.com
    ports:
      - ${APP0_PORT}:${APP0_PORT}
    networks:
      - app_net
    volumes:
      - datashare:/datashare
    entrypoint:
      - /bin/bash
      - entrypoint.sh
      - ${APP0_PORT}

  app1:
    restart: unless-stopped
    container_name: ${PROJECT_NAME}_app1
    env_file:
      - ./src-app1/.env.docker
    build:
      context: ./src-app1
      args:
        url_pypi: ${url_pypi_index}
        url_docker: ${url_docker_index}
    environment:
      - DJANGO_SUPERUSER_USERNAME=admin
      - DJANGO_SUPERUSER_PASSWORD=myVerySecretPswd
      - DJANGO_SUPERUSER_EMAIL=admin@rockingclimbing.com
    ports:
      - ${APP1_PORT}:${APP1_PORT}
    networks:
      - app_net
    volumes:
      - datashare:/datashare
    entrypoint:
      - /bin/bash
      - entrypoint.sh
      - ${APP1_PORT}

  app2:
    restart: unless-stopped
    container_name: ${PROJECT_NAME}_app2
    env_file:
      - ./src-app2/.env.docker
    build:
      context: ./src-app2
      args:
        url_pypi: ${url_pypi_index}
        url_docker: ${url_docker_index}
    ports:
      - ${APP2_PORT}:${APP2_PORT}
    environment:
      - DJANGO_SUPERUSER_USERNAME=admin
      - DJANGO_SUPERUSER_PASSWORD=myVerySecretPswd
      - DJANGO_SUPERUSER_EMAIL=admin@rockingclimbing.com
    networks:
      - app_net
    volumes:
      - datashare:/datashare
    entrypoint:
      - /bin/bash
      - entrypoint.sh
      - ${APP2_PORT}

volumes:
  datashare:
  datalogs:
  datacache_nginx:

networks:
  app_net:
```

## Example builder script

```bash
#!/bin/bash

certs_dir="./certs"

mkdir -p $certs_dir
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout $certs_dir/nginx.key -out $certs_dir/nginx.crt -subj "/C=US/ST=State/L=City/O=Organization/CN=localhost"
echo "Certificates generated in $certs_dir/"
```

## Django configurations

For Django to work, you need to watch 2 important things:

1. Reverse proxy prefix using `FORCE_SCRIPT_NAME`
1. Static file server with `STATIC_ROOT`, `STATIC_URL`

Suggested `.env` to be configured:

```bash
REVERSE_PROXY_PREFIX=/app1
STATIC_ROOT_PATH=/datashare/www/static
```

Suggested code to be placed into `settings.py`

```python
"""
Django settings for main project.
Generated by 'django-admin startproject' using Django 5.2.9.
"""

import os

...

FORCE_SCRIPT_NAME = os.getenv("REVERSE_PROXY_PREFIX", "")

STATIC_URL = "/static/"
_STATIC_ROOT = os.getenv("STATIC_ROOT_PATH", "")
if _STATIC_ROOT:
    static_root = Path(_STATIC_ROOT).expanduser()
    if not static_root.is_dir():
        static_root.mkdir(parents=True, exist_ok=True)
    STATIC_ROOT = str(static_root.absolute())

```

Take note of pre and trailing `/`, `STATIC_URL = "/static/"` means
that `FORCE_SCRIPT_NAME` is ignored and it will always route to
root `host_uri/static/`.

This will correspond to the nginx's default.conf here

```conf
    location /static/ {
        alias /datashare/www/static/;
    }
```

In this configurations, we have the 1 nginx static server to host
all of the Django's app static files. We assume all static files
are common (better and probably more efficient this way).
